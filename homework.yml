---
- name: Generate inventory file on bastion
  hosts: localhost
  vars:
    guid: dummyvalue
    default_inventory_file: /etc/ansible/hosts
  tasks:
    - name: Copy inventory file from source
      copy:
        src: "{{playbook_dir}}/ansible_inventory"
        dest: "{{default_inventory_file}}"
    - name: Get GUID from host name
      shell: hostname|awk -F. '{print $2}'
      register: guid_output
    - name: Set GUID variable
      set_fact:
        guid: "{{guid_output.stdout}}"
    - name: Replace GUID in ansible inventory
      replace:
        path: "{{default_inventory_file}}"
        regexp: 'PLACEHOLDER_GUID'
        replace: "{{guid}}"
    - name: Reload inventory file to capture GUID updates
      meta: refresh_inventory

- name: Validate Docker configuration on nodes
  hosts: nodes
  tasks:
    - name: Install Docker if necessary
      package:
        name: docker
        state: present
    - name: Start Docker service if necessary
      service:
        name: docker
        state: started

- name: Configure LDAP authentication
  hosts: localhost
  vars:
    tempfilepath: dummyvalue
    default_inventory_file: /etc/ansible/hosts
  tasks:
    - name: Create temporary file to hold certificate
      tempfile:
        state: file
      register: tempfile_output
    - name: Set temporary file path variable
      set_fact:
        tempfilepath: "{{tempfile_output.path}}"
    - name: Download CA certificate
      get_url:
        url: http://ipa.shared.example.opentlc.com/ipa/config/ca.crt
        dest: "{{tempfilepath}}"
        force: yes
    - name: Replace CA certificate path in ansible inventory
      replace:
        path: "{{default_inventory_file}}"
        regexp: 'PLACEHOLDER_CA_FILEPATH'
        replace: "{{tempfilepath}}"

- name: Validate OpenShift packages on bastion
  hosts: localhost
  tasks:
    - name: Install OpenShift utils package if necessary
      package:
        name: atomic-openshift-utils
        state: present
    - name: Install OpenShift clients package if necesary
      package:
        name: atomic-openshift-clients
        state: present

- name: Check OpenShift pre-requisites
  import_playbook: /usr/share/ansible/openshift-ansible/playbooks/prerequisites.yml

- name: Run OpenShift installer
  import_playbook: /usr/share/ansible/openshift-ansible/playbooks/deploy_cluster.yml

- name: Verify OpenShift installation
  hosts: localhost
  tasks:
    - name: Copy .kube directory from master1 to bastion
      synchronize:
        src: /root/.kube/config
        dest: /root/.kube/config
      delegate_to: masters[0]